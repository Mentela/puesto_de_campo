import { createBot, createProvider, createFlow, addKeyword } from '@builderbot/bot'
import { JsonFileDB as Database } from '@builderbot/database-json'
import { MetaProvider as Provider } from '@builderbot/provider-meta'

const PORT = process.env.PORT ?? 3002
const pedidos = {}

/**
 * Env√≠a el pedido a la sucursal de forma directa.
 */
const sendOrderDirect = async (ctx, provider, sucursal) => {
    const pedido = pedidos[ctx.from] || {}
    const numeroSucursal = '+5493584876535' // N√∫mero de prueba en formato E.164

    // Aseguramos que ctx.from est√© en formato E.164
    let clientNumber = ctx.from
    if (!clientNumber.startsWith('+')) {
        clientNumber = `+${clientNumber}`
    }

    let mensaje = `üì¢ Nuevo pedido desde ${sucursal}:\n\n` +
        `üì± Cliente: ${clientNumber}\n`
    if (pedido.formulario) {
        mensaje += `Detalles:\n${pedido.formulario}`
    } else {
        mensaje += `No se encontraron detalles en el pedido.`
    }
    console.log('sendOrderDirect - Mensaje a enviar:', mensaje)

    try {
        const resSucursal = await provider.sendMessage(numeroSucursal, mensaje, {})
        console.log('sendOrderDirect - Respuesta sucursal:', resSucursal)
        const resCliente = await provider.sendMessage(clientNumber, '‚úÖ Tu pedido ha sido enviado y est√° en proceso de revisi√≥n.', {})
        console.log('sendOrderDirect - Respuesta cliente:', resCliente)
    } catch (error) {
        console.error('sendOrderDirect - Error al enviar el mensaje:', error)
        try {
            await provider.sendMessage(clientNumber, '‚ùå Hubo un error al enviar tu pedido. Por favor, intenta nuevamente.', {})
        } catch (err) {
            console.error('sendOrderDirect - Error al notificar al cliente:', err)
        }
    }
    delete pedidos[ctx.from]
}

/**
 * 1. Flujo de captura de datos (pedidoFlow)
 */
const pedidoFlow = addKeyword(['pedido']).addAnswer(
    'Para realizar tu pedido, ingresa la siguiente informaci√≥n separada por comas: Nombre completo, DNI, Direcci√≥n (calle, n√∫mero, piso), Detalle del producto (producto y cantidad), Monto de pago. Ejemplo: Juan P√©rez, 12345678, Av. Siempre Viva 742, Pizza Grande 2, $1500. Por favor, completa con tus datos:',
    { capture: true },
    async (ctx, { gotoFlow }) => {
        console.log("pedidoFlow - Input recibido:", JSON.stringify(ctx.body))
        const inputLimpio = ctx.body.trim()
        console.log("pedidoFlow - Input limpio:", inputLimpio)
        pedidos[ctx.from] = {
            ...pedidos[ctx.from],
            formulario: inputLimpio
        }
        console.log("pedidoFlow - Pedido almacenado:", pedidos[ctx.from])
        return gotoFlow(resumenFlow)
    }
)

/**
 * 2. Flujo de resumen (resumenFlow)
 */
const resumenFlow = addKeyword([]).addAnswer(
    'Quieres confirmar el pedido?',
    {
        buttons: [
            { body: 'Confirmar pedido' },
            { body: 'Cancelar' },
        ],
        capture: true,
    },
    async (ctx, { provider, gotoFlow }) => {
        console.log("resumenFlow - Input recibido:", JSON.stringify(ctx.body))
        const respuesta = ctx.body.trim().toLowerCase()
        console.log("resumenFlow - Respuesta procesada:", respuesta)
        if (respuesta.includes('confirmar')) {
            return gotoFlow(confirmacionFlow)
        }
        if (respuesta.includes('cancelar')) {
            await provider.sendMessage(ctx.from, 'Has cancelado tu pedido. Volviendo al men√∫ principal.', {})
            return gotoFlow(welcomeFlow)
        }
        await provider.sendMessage(ctx.from, 'Opci√≥n no v√°lida. Por favor, selecciona "Confirmar pedido" o "Cancelar".', {})
        return gotoFlow(resumenFlow)
    }
)

/**
 * 3. Flujo de confirmaci√≥n final (confirmacionFlow)
 */
const confirmacionFlow = addKeyword([]).addAnswer(
    'Enviando tu pedido...',
    {},
    async (ctx, { provider, gotoFlow }) => {
        console.log('confirmacionFlow - Iniciando env√≠o del pedido')
        const pedido = pedidos[ctx.from]
        if (!pedido?.sucursal || !pedido?.formulario) {
            console.log('confirmacionFlow - Pedido inv√°lido:', pedido)
            await provider.sendMessage(ctx.from, 'No se encontr√≥ un pedido v√°lido. Volviendo al inicio.', {})
            return gotoFlow(welcomeFlow)
        }
        try {
            console.log('voy por aca')
            await sendOrderDirect(ctx, provider, pedido.sucursal)
        } catch (e) {
            console.error('confirmacionFlow - Error en sendOrderDirect:', e)
        }
        console.log('confirmacionFlow - Pedido enviado, regresando a welcomeFlow')
        return gotoFlow(welcomeFlow)
    }
)

/**
 * Flujos para seleccionar la sucursal.
 */
const goyenaFlow = addKeyword('Goyena').addAnswer(
    'Gracias por comunicarte con GOYENA. ¬øQu√© deseas hacer?',
    {
        buttons: [
            { body: 'Iniciar pedido' },
            { body: 'Cancelar' }
        ]
    },
    async (ctx, { gotoFlow }) => {
        console.log('goyenaFlow - Usuario seleccion√≥ GOYENA')
        pedidos[ctx.from] = { ...pedidos[ctx.from], sucursal: 'Goyena' }
        const respuesta = ctx.body.trim().toLowerCase()
        console.log('goyenaFlow - Respuesta:', respuesta)
        if (respuesta === 'iniciar pedido') {
            return gotoFlow(pedidoFlow)
        } else if (respuesta === 'cancelar') {
            return gotoFlow(welcomeFlow)
        }
    }
)

const suipachaFlow = addKeyword('Suipacha').addAnswer(
    'Gracias por comunicarte con SUIPACHA. ¬øQu√© deseas hacer?',
    {
        buttons: [
            { body: 'Iniciar pedido' },
            { body: 'Cancelar' }
        ]
    },
    async (ctx, { gotoFlow }) => {
        console.log('suipachaFlow - Usuario seleccion√≥ SUIPACHA')
        pedidos[ctx.from] = { ...pedidos[ctx.from], sucursal: 'Suipacha' }
        const respuesta = ctx.body.trim().toLowerCase()
        console.log('suipachaFlow - Respuesta:', respuesta)
        if (respuesta === 'iniciar pedido') {
            return gotoFlow(pedidoFlow)
        } else if (respuesta === 'cancelar') {
            return gotoFlow(welcomeFlow)
        }
    }
)

const guzmanFlow = addKeyword('Guzm√°n').addAnswer(
    'Gracias por comunicarte con GUZM√ÅN. ¬øQu√© deseas hacer?',
    {
        buttons: [
            { body: 'Iniciar pedido' },
            { body: 'Cancelar' }
        ]
    },
    async (ctx, { gotoFlow }) => {
        console.log('guzmanFlow - Usuario seleccion√≥ GUZM√ÅN')
        pedidos[ctx.from] = { ...pedidos[ctx.from], sucursal: 'Guzm√°n' }
        const respuesta = ctx.body.trim().toLowerCase()
        console.log('guzmanFlow - Respuesta:', respuesta)
        if (respuesta === 'iniciar pedido') {
            return gotoFlow(pedidoFlow)
        } else if (respuesta === 'cancelar') {
            return gotoFlow(welcomeFlow)
        }
    }
)

/**
 * Flujos para pedidos de Env√≠os y Retiros.
 */
const deliveryFlow = addKeyword('Env√≠os').addAnswer(
    '¬øCon qu√© sucursal quisieras comunicarte?',
    {
        buttons: [
            { body: 'Pedro Goyena 298' },
            { body: 'Suipacha 306' },
            { body: 'Gob. Guzm√°n 1560' },
        ],
    },
    async (ctx, { gotoFlow }) => {
        console.log('deliveryFlow - Usuario eligi√≥ Env√≠os')
        pedidos[ctx.from] = { tipoPedido: 'Env√≠o' }
        const normalizedBody = ctx.body.trim().toLowerCase()
        console.log('deliveryFlow - Respuesta:', normalizedBody)
        if (normalizedBody.includes('goyena')) return gotoFlow(goyenaFlow)
        if (normalizedBody.includes('suipacha')) return gotoFlow(suipachaFlow)
        if (normalizedBody.includes('guzm√°n')) return gotoFlow(guzmanFlow)
    }
)

const pickupFlow = addKeyword('Retiros').addAnswer(
    '¬øCon qu√© sucursal quisieras comunicarte?',
    {
        buttons: [
            { body: 'Pedro Goyena 298' },
            { body: 'Suipacha 306' },
            { body: 'Gob. Guzm√°n 1560' },
        ],
    },
    async (ctx, { gotoFlow }) => {
        console.log('pickupFlow - Usuario eligi√≥ Retiros')
        pedidos[ctx.from] = { tipoPedido: 'Retiro' }
        const normalizedBody = ctx.body.trim().toLowerCase()
        console.log('pickupFlow - Respuesta:', normalizedBody)
        if (normalizedBody.includes('goyena')) return gotoFlow(goyenaFlow)
        if (normalizedBody.includes('suipacha')) return gotoFlow(suipachaFlow)
        if (normalizedBody.includes('guzm√°n')) return gotoFlow(guzmanFlow)
    }
)

/**
 * Flujo de Consultas/FAQ.
 */
const faqFlow = addKeyword('Consultas').addAnswer(
    'Nuestras preguntas m√°s frecuentes:\n1. Horarios de atenci√≥n\n2. Direcci√≥n de sucursales\n3. Precios\n4. Medios de pago\n5. Tel√©fonos de sucursales\n6. Otra consulta\n\nPor favor, respond√© con el n√∫mero correspondiente o seleccion√° una opci√≥n:',
    {
        capture: true,
        buttons: [
            { body: 'Volver al inicio' },
            { body: 'Repetir consultas' },
        ],
    },
    async (ctx, { gotoFlow, flowDynamic }) => {
        console.log('faqFlow - Input recibido:', JSON.stringify(ctx.body))
        const userResponse = ctx.body.trim()
        if (userResponse === 'Volver al inicio') return gotoFlow(welcomeFlow)
        if (userResponse === 'Repetir consultas') return gotoFlow(faqFlow)

        const responses = {
            1: 'Nuestro horario es de 9:00 a 18:00 de lunes a viernes.',
            2: 'Estamos en Pedro Goyena 298, Suipacha 306 y Gobernador Guzm√°n 1560.',
            3: 'Consult√° la lista de precios aqu√≠: [link]',
            4: 'Aceptamos efectivo y tarjetas.',
            5: 'Tel√©fonos: Goyena 1234, Suipacha 5678, Guzm√°n 91011.',
            6: 'Por favor, escrib√≠ tu consulta y te responderemos a la brevedad.',
        }
        await flowDynamic(responses[userResponse] || 'Opci√≥n no v√°lida. Respond√© con un n√∫mero del 1 al 6.')
    }
)

/**
 * Flujo de bienvenida.
 */
const welcomeFlow = addKeyword(['Hola', 'Inicio']).addAnswer(
    'Hola, gracias por comunicarte con Puesto de Campo. Solo podemos responder mensajes ESCRITOS. ¬øEn qu√© podemos ayudarte?',
    {
        buttons: [
            { body: 'Env√≠os' },
            { body: 'Retiros' },
            { body: 'Consultas' },
        ],
    },
    async (ctx, { gotoFlow }) => {
        console.log('welcomeFlow - Input recibido:', ctx.body)
        if (ctx.body === 'Env√≠os') return gotoFlow(deliveryFlow)
        if (ctx.body === 'Retiros') return gotoFlow(pickupFlow)
        if (ctx.body === 'Consultas') return gotoFlow(faqFlow)
    }
)

const main = async () => {
    const adapterFlow = createFlow([
        welcomeFlow,
        deliveryFlow,
        pickupFlow,
        goyenaFlow,
        suipachaFlow,
        guzmanFlow,
        pedidoFlow,
        resumenFlow,
        confirmacionFlow,
        faqFlow,
    ])
    const adapterProvider = createProvider(Provider, {
        jwtToken: process.env.JWT_TOKEN,
        numberId: process.env.NUMBER_ID,
        verifyToken: process.env.SECRET_TOKEN,
        version: 'v21.0',
    })
    const adapterDB = new Database({ filename: 'db.json' })
    const { httpServer } = await createBot({
        flow: adapterFlow,
        provider: adapterProvider,
        database: adapterDB,
    })
    httpServer(+PORT)
}

main()
